import{_ as e,c as a,o as s,a as n}from"./app-h7mth2r0.js";const t={},l=n(`<h1 id="keycloak-15" tabindex="-1"><a class="header-anchor" href="#keycloak-15"><span>Keycloak 15</span></a></h1><h2 id="install-java" tabindex="-1"><a class="header-anchor" href="#install-java"><span>Install Java</span></a></h2><p>Primeiramento instale o OpenJDK-17</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># apt install openjdk-17-jre-headless</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="install-keycloak" tabindex="-1"><a class="header-anchor" href="#install-keycloak"><span>Install keycloak</span></a></h2><h3 id="download-keycloak" tabindex="-1"><a class="header-anchor" href="#download-keycloak"><span>Download Keycloak</span></a></h3><ul><li>Faça o download do keycloak OBS: Aqui estou usando a versão 15.1.1</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># wget -c https://github.com/keycloak/keycloak/releases/download/15.1.1/keycloak-15.1.1.tar.gz</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>Unpack keycloak</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># tar zxvf keycloak-15.1.1.tar.gz</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Eu movi a pasta extraida <strong>keycloak-15.1.1</strong> para <strong>/opt/keycloak</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># mv keycloak-15.1.1 /opt/keycloak</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="generate-ssl-to-keycloak" tabindex="-1"><a class="header-anchor" href="#generate-ssl-to-keycloak"><span>Generate SSL to keycloak</span></a></h3><blockquote><p>Utilizei um certificado Let&#39;s Encrypt</p></blockquote><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">certbot <span class="token parameter variable">-v</span> certonly <span class="token parameter variable">--standalone</span> <span class="token parameter variable">-d</span> auth.bagarote.dev.br</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Foi criado em **/etc/letsencrypt/live/auth.bagarote.dev.br/*.pem</p><h3 id="configuration-keycloak" tabindex="-1"><a class="header-anchor" href="#configuration-keycloak"><span>Configuration keycloak</span></a></h3><h4 id="ssl" tabindex="-1"><a class="header-anchor" href="#ssl"><span>SSL</span></a></h4><p>Edite o arquivo <strong>/opt/keycloak/standalone/configuration/standalone.xml</strong> e adicione as linhas abaixo</p><div class="language-conf line-numbers-mode" data-highlighter="prismjs" data-ext="conf" data-title="conf"><pre><code><span class="line">&lt;security-realm name=&quot;UndertowRealm&quot;&gt;</span>
<span class="line">  &lt;server-identities&gt;</span>
<span class="line">    &lt;ssl&gt;</span>
<span class="line">      &lt;keystore path=&quot;keycloak.jks&quot; relative-to=&quot;jboss.server.config.    dir&quot; keystore-password=&quot;123456&quot; /&gt;</span>
<span class="line">    &lt;/ssl&gt;</span>
<span class="line">  &lt;/server-identities&gt;</span>
<span class="line">&lt;/security-realm&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Altere o subsystem para o undertow</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">&lt;subsystem xmlns=&quot;urn:jboss:domain:undertow:12.0&quot; default-server=&quot;default-server&quot; default-virtual-host=&quot;default-host&quot; default-servlet-container=&quot;default&quot; default-security-domain=&quot;other&quot; statistics-enabled=&quot;\${wildfly.undertow.statistics-enabled:\${wildfly.statistics-enabled:false}}&quot;&gt;</span>
<span class="line">    &lt;buffer-cache name=&quot;default&quot;/&gt;</span>
<span class="line">    &lt;server name=&quot;default-server&quot;&gt;</span>
<span class="line">        &lt;http-listener name=&quot;default&quot; socket-binding=&quot;http&quot; redirect-socket=&quot;https&quot; enable-http2=&quot;true&quot;/&gt;</span>
<span class="line">        &lt;https-listener name=&quot;https&quot; socket-binding=&quot;https&quot; security-realm=&quot;UndertowRealm&quot; enable-http2=&quot;true&quot;/&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="database" tabindex="-1"><a class="header-anchor" href="#database"><span>Database</span></a></h4><p>Remover estas linhas:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">&lt;datasource jndi-name=&quot;java:jboss/datasources/ExampleDS&quot; pool-name=&quot;ExampleDS&quot; enabled=&quot;true&quot; use-java-context=&quot;true&quot; statistics-enabled=&quot;\${wildfly.datasources.statistics-enabled:\${wildfly.statistics-enabled:false}}&quot;&gt;</span>
<span class="line">    &lt;connection-url&gt;jdbc:h2:mem:test;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE&lt;/connection-url&gt;</span>
<span class="line">    &lt;driver&gt;h2&lt;/driver&gt;</span>
<span class="line">    &lt;security&gt;</span>
<span class="line">        &lt;user-name&gt;sa&lt;/user-name&gt;</span>
<span class="line">        &lt;password&gt;sa&lt;/password&gt;</span>
<span class="line">    &lt;/security&gt;</span>
<span class="line">&lt;/datasource&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Alterar a configuracao do keycloakDS alterando para o postgresql</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">&lt;datasources&gt;</span>
<span class="line">    &lt;datasource jndi-name=&quot;java:jboss/datasources/KeycloakDS&quot; pool-name=&quot;KeycloakDS&quot; enabled=&quot;true&quot; use-java-context=&quot;true&quot; statistics-enabled=&quot;\${wildfly.datasources.statistics-enabled:\${wildfly.statistics-enabled:false}}&quot;&gt;</span>
<span class="line">        &lt;connection-url&gt;jdbc:postgresql://db.bagarote.com.br:5432/keycloak&lt;/connection-url&gt;</span>
<span class="line">        &lt;driver&gt;postgres&lt;/driver&gt;</span>
<span class="line">        &lt;security&gt;</span>
<span class="line">            &lt;user-name&gt;dev&lt;/user-name&gt;</span>
<span class="line">            &lt;password&gt;123&lt;/password&gt;</span>
<span class="line">        &lt;/security&gt;</span>
<span class="line">    &lt;/datasource&gt;</span>
<span class="line">    &lt;drivers&gt;</span>
<span class="line">        &lt;driver name=&quot;postgres&quot; module=&quot;com.postgres&quot;&gt;</span>
<span class="line">            &lt;driver-class&gt;org.postgresql.Driver&lt;/driver-class&gt;</span>
<span class="line">            &lt;xa-datasource-class&gt;org.postgresql.xa.PGXADataSource&lt;/xa-datasource-class&gt;</span>
<span class="line">        &lt;/driver&gt;</span>
<span class="line">    &lt;/drivers&gt;</span>
<span class="line">&lt;/datasources&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Altera a linha <strong>default-binding</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">&lt;default-bindings context-service=&quot;java:jboss/ee/concurrency/context/default&quot; datasource=&quot;java:jboss/datasources/KeycloakDS&quot; managed-executor-service=&quot;java:jboss/ee/concurrency/executor/default&quot; managed-scheduled-executor-service=&quot;java:jboss/ee/concurrency/scheduler/default&quot; managed-thread-factory=&quot;java:jboss/ee/concurrency/factory/default&quot;/&gt;</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="rodando-o-keycloak" tabindex="-1"><a class="header-anchor" href="#rodando-o-keycloak"><span>Rodando o keycloak</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/bash /opt/keycloak/bin/standalone.sh <span class="token parameter variable">-b</span><span class="token operator">=</span><span class="token operator">&lt;</span>ip-externo<span class="token operator">&gt;</span> <span class="token parameter variable">-bmanagement</span><span class="token operator">=</span><span class="token operator">&lt;</span>ip-externo<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="criei-um-service-no-systemd-para-facilitar-o-gerenciamento" tabindex="-1"><a class="header-anchor" href="#criei-um-service-no-systemd-para-facilitar-o-gerenciamento"><span>Criei um service no systemd para facilitar o gerenciamento</span></a></h2><p>Em <strong>/etc/systemd/system/</strong> criei <strong>keycloak.service</strong> com o seguinte conteúdo</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span></span>
<span class="line"><span class="token assign-left variable">Description</span><span class="token operator">=</span>Manager <span class="token function">service</span> keycloak</span>
<span class="line"><span class="token assign-left variable">After</span><span class="token operator">=</span>multi-user.target</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">[</span>Service<span class="token punctuation">]</span></span>
<span class="line"><span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/bash /opt/keycloak/bin/standalone.sh <span class="token parameter variable">-b</span><span class="token operator">=</span><span class="token operator">&lt;</span>ip-externo<span class="token operator">&gt;</span> <span class="token parameter variable">-bmanagement</span><span class="token operator">=</span><span class="token operator">&lt;</span>ip-externo<span class="token operator">&gt;</span></span>
<span class="line"><span class="token assign-left variable">Type</span><span class="token operator">=</span>simple</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">[</span>Install<span class="token punctuation">]</span></span>
<span class="line"><span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Após a criação do arquivo instalei para iniciar sempre junto com a máquina</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># systemctl enable --now keycloak.service</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="teste-funcionamento" tabindex="-1"><a class="header-anchor" href="#teste-funcionamento"><span>Teste funcionamento</span></a></h2><blockquote><p>Abra seu browser no endereço criado para o keycloak na porta :8443 Ex: auth.bagarote.dev.br:8443</p></blockquote><hr><p>ls /etc/letsencrypt/live/auth2.bagarote.dev.br openssl pkcs12 -export -out keycloak.p12 -inkey /etc/letsencrypt/live/auth.bagarote.dev.br/privkey.pem -in /etc/letsencrypt/live/auth.bagarote.dev.br/fullchain.pem -name keycloak-certificate keytool -importkeystore -srckeystore keycloak.p12 -destkeystore keycloak.jks -srcstoretype pkcs12 rm keycloak.p12 keytool -list -v -keystore keycloak.jks</p>`,40),i=[l];function r(o,c){return s(),a("div",null,i)}const p=e(t,[["render",r],["__file","keycloak-15.html.vue"]]),u=JSON.parse('{"path":"/keycloak/keycloak-15.html","title":"Keycloak 15","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"Install Java","slug":"install-java","link":"#install-java","children":[]},{"level":2,"title":"Install keycloak","slug":"install-keycloak","link":"#install-keycloak","children":[{"level":3,"title":"Download Keycloak","slug":"download-keycloak","link":"#download-keycloak","children":[]},{"level":3,"title":"Generate SSL to keycloak","slug":"generate-ssl-to-keycloak","link":"#generate-ssl-to-keycloak","children":[]},{"level":3,"title":"Configuration keycloak","slug":"configuration-keycloak","link":"#configuration-keycloak","children":[]},{"level":3,"title":"Rodando o keycloak","slug":"rodando-o-keycloak","link":"#rodando-o-keycloak","children":[]}]},{"level":2,"title":"Criei um service no systemd para facilitar o gerenciamento","slug":"criei-um-service-no-systemd-para-facilitar-o-gerenciamento","link":"#criei-um-service-no-systemd-para-facilitar-o-gerenciamento","children":[]},{"level":2,"title":"Teste funcionamento","slug":"teste-funcionamento","link":"#teste-funcionamento","children":[]}],"git":{"updatedTime":1748361051000,"contributors":[{"name":"Celso Nery","email":"celso.nery@gmail.com","commits":1}]},"filePathRelative":"keycloak/keycloak-15.md"}');export{p as comp,u as data};
