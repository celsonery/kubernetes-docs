import{_ as a,c as s,o as e,e as n}from"./app-BzyLCCjA.js";const i={},t=n(`<h1 id="gitlab-ce" tabindex="-1"><a class="header-anchor" href="#gitlab-ce"><span>Gitlab - CE</span></a></h1><h3 id="instalacao" tabindex="-1"><a class="header-anchor" href="#instalacao"><span>Instalação</span></a></h3><h4 id="reset-root-password" tabindex="-1"><a class="header-anchor" href="#reset-root-password"><span>Reset Root Password</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> gitlab <span class="token function">bash</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">gitlab-rails console <span class="token parameter variable">-e</span> production</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">user <span class="token operator">=</span> User.where<span class="token punctuation">(</span>id: <span class="token number">1</span><span class="token punctuation">)</span>.first</span>
<span class="line">user.password <span class="token operator">=</span> <span class="token string">&#39;your secret&#39;</span></span>
<span class="line">user.password_confirmation <span class="token operator">=</span> <span class="token string">&#39;your secret&#39;</span></span>
<span class="line">user.save</span>
<span class="line"><span class="token builtin class-name">exit</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="backup" tabindex="-1"><a class="header-anchor" href="#backup"><span>Backup</span></a></h3><div class="language-crontab line-numbers-mode" data-highlighter="prismjs" data-ext="crontab" data-title="crontab"><pre><code><span class="line">00 20 * * * docker exec -t gitlab gitlab-backup create SKIP=registry CRON=1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="restore" tabindex="-1"><a class="header-anchor" href="#restore"><span>Restore</span></a></h3><ul><li>Stop the processes that are connected to the database</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token operator">&lt;</span>name of container<span class="token operator">&gt;</span> gitlab-ctl stop puma</span>
<span class="line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token operator">&lt;</span>name of container<span class="token operator">&gt;</span> gitlab-ctl stop sidekiq</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Verify that the processes are all down before continuing</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token operator">&lt;</span>name of container<span class="token operator">&gt;</span> gitlab-ctl status</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>Run the restore. NOTE: &quot;_gitlab_backup.tar&quot; is omitted from the name</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token operator">&lt;</span>name of container<span class="token operator">&gt;</span> gitlab-backup restore <span class="token assign-left variable">BACKUP</span><span class="token operator">=</span>16759806511_2023_02_09_14.10.5</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>Restart the GitLab container</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> restart <span class="token operator">&lt;</span>name of container<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>Check GitLab</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token operator">&lt;</span>name of container<span class="token operator">&gt;</span> gitlab-rake gitlab:check <span class="token assign-left variable">SANITIZE</span><span class="token operator">=</span>true</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="update-gitlab" tabindex="-1"><a class="header-anchor" href="#update-gitlab"><span>Update Gitlab</span></a></h3><ul><li><p>Realizar o update somente após os backups estiverem terminados</p></li><li><p>Conectar na maquina com o usuário Bagarote</p></li><li><p>Altere o arquivo docker-compose.yml e adicione a nova versao na imagem docker</p></li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">$ <span class="token function">docker-compose</span> pull</span>
<span class="line">$ <span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Aguardar o container gitlab ficar em <strong>Healthy</strong></li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">$ <span class="token function">watch</span> <span class="token parameter variable">-n2</span> <span class="token function">docker</span> <span class="token function">ps</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="liberar-espaco" tabindex="-1"><a class="header-anchor" href="#liberar-espaco"><span>Liberar espaço</span></a></h3><ul><li><p>Entrar em cada aplicação e remover imagens antigas - Docker</p></li><li><p>Script para remover imagens antigas e liberar espaço em disco</p></li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">\`</span><span class="token function">docker</span> image <span class="token function">ls</span> <span class="token operator">|</span> <span class="token function">grep</span> etotem/front <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $2}&#39;</span> <span class="token operator">|</span> <span class="token function">egrep</span> <span class="token parameter variable">-v</span> <span class="token string">&#39;(dev|hml|latest|v1391|v1601|v1639)&#39;</span><span class="token variable">\`</span></span><span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token function">docker</span> image <span class="token function">rm</span> <span class="token string">&quot;registry.bagarote.com.br/karyon/etotem/front:&quot;</span><span class="token variable">$i</span><span class="token punctuation">;</span><span class="token keyword">done</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><p>Script 2 para remover imagens antigas e liberar espaço em disco</p></li><li><p>Liberar espaço nos registry - Gitlab Entrar no container gitlab</p></li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">$ <span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="migracao" tabindex="-1"><a class="header-anchor" href="#migracao"><span>Migração</span></a></h3><ul><li>Transferir os aquivos abaixo todos com permissao 600</li></ul><p>Gitlab</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">/opt/gitlab/data/config/gitlab.rb</span>
<span class="line">/opt/gitlab/data/config/gitlab-secrets.json</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>Runner</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">/opt/gitlab/runners/shared/config/config.toml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="ativacao-ssl" tabindex="-1"><a class="header-anchor" href="#ativacao-ssl"><span>Ativação <strong>SSL</strong></span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"></div></div><h3 id="ativacao-envio-de-e-mail" tabindex="-1"><a class="header-anchor" href="#ativacao-envio-de-e-mail"><span>Ativação <strong>Envio de e-mail</strong></span></a></h3><ul><li>Editar o arquivo /opt/gitlab/config/gitlab.rb</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">gitlab_rails<span class="token punctuation">[</span><span class="token string">&#39;smtp_enable&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="line">gitlab_rails<span class="token punctuation">[</span><span class="token string">&#39;smtp_address&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;smtp.server&quot;</span></span>
<span class="line">gitlab_rails<span class="token punctuation">[</span><span class="token string">&#39;smtp_port&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">465</span></span>
<span class="line"><span class="token comment"># gitlab_rails[&#39;smtp_user_name&#39;] = &quot;smtp user&quot;</span></span>
<span class="line"><span class="token comment"># gitlab_rails[&#39;smtp_password&#39;] = &quot;smtp password&quot;</span></span>
<span class="line">gitlab_rails<span class="token punctuation">[</span><span class="token string">&#39;smtp_domain&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;example.com&quot;</span></span>
<span class="line">gitlab_rails<span class="token punctuation">[</span><span class="token string">&#39;smtp_authentication&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;login&quot;</span></span>
<span class="line">gitlab_rails<span class="token punctuation">[</span><span class="token string">&#39;smtp_enable_starttls_auto&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="line">gitlab_rails<span class="token punctuation">[</span><span class="token string">&#39;smtp_openssl_verify_mode&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;peer&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Entrar no container gitlab</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">$ <span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> gitlab <span class="token function">bash</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>Criar as credenciais do email</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># gitlab-rake gitlab:smtp:secret:edit</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>Apos o editor abrir insira as credenciais</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">user_name: <span class="token string">&#39;smtp user&#39;</span></span>
<span class="line">password: <span class="token string">&#39;smtp password&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Após as configurações feitas, reinicie as configurações do gitlab</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">$ gitlab-ctl reconfigure</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Documentação oficial</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">https://docs.gitlab.com/omnibus/settings/smtp.html</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="ativacao-container-registry" tabindex="-1"><a class="header-anchor" href="#ativacao-container-registry"><span>Ativação <strong>Container Registry</strong></span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"></div></div><h3 id="ativacao-gitlab-runner" tabindex="-1"><a class="header-anchor" href="#ativacao-gitlab-runner"><span>Ativação <strong>Gitlab-runner</strong></span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"></div></div>`,54),l=[t];function r(p,o){return e(),s("div",null,l)}const d=a(i,[["render",r],["__file","23-gitlab.html.vue"]]),u=JSON.parse('{"path":"/br/kubernetes/23-gitlab.html","title":"Gitlab - CE","lang":"Português","frontmatter":{},"headers":[{"level":3,"title":"Instalação","slug":"instalacao","link":"#instalacao","children":[]},{"level":3,"title":"Backup","slug":"backup","link":"#backup","children":[]},{"level":3,"title":"Restore","slug":"restore","link":"#restore","children":[]},{"level":3,"title":"Update Gitlab","slug":"update-gitlab","link":"#update-gitlab","children":[]},{"level":3,"title":"Liberar espaço","slug":"liberar-espaco","link":"#liberar-espaco","children":[]},{"level":3,"title":"Migração","slug":"migracao","link":"#migracao","children":[]},{"level":3,"title":"Ativação SSL","slug":"ativacao-ssl","link":"#ativacao-ssl","children":[]},{"level":3,"title":"Ativação Envio de e-mail","slug":"ativacao-envio-de-e-mail","link":"#ativacao-envio-de-e-mail","children":[]},{"level":3,"title":"Ativação Container Registry","slug":"ativacao-container-registry","link":"#ativacao-container-registry","children":[]},{"level":3,"title":"Ativação Gitlab-runner","slug":"ativacao-gitlab-runner","link":"#ativacao-gitlab-runner","children":[]}],"git":{"updatedTime":1748002949000,"contributors":[{"name":"Celso Nery","email":"celso.nery@gmail.com","commits":1}]},"filePathRelative":"br/kubernetes/23-gitlab.md"}');export{d as comp,u as data};
